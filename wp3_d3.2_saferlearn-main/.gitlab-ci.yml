# This file is a template, and might need editing before it works on your project.
# To contribute improvements to CI/CD templates, please follow the Development guide at:
# https://docs.gitlab.com/ee/development/cicd/templates.html
# This specific template is located at:
# https://gitlab.com/gitlab-org/gitlab/-/blob/master/lib/gitlab/ci/templates/Python.gitlab-ci.yml

# Official language image. Look for the different tagged releases at:
# https://hub.docker.com/r/library/python/tags/
image: nvcr.io/nvidia/cuda:12.8.0-cudnn-devel-ubuntu22.04

# Change pip's cache directory to be inside the project directory since we can
# only cache local items.
variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.saferlearn"

# Pip's cache doesn't store the python packages
# https://pip.pypa.io/en/stable/topics/caching/
#
# If you want to also cache the installed packages, you have to install
# them in a virtualenv and cache it as well.
cache:
  paths:
    - .saferlearn/

default:
  interruptible: true
  tags:
    - gpu
  before_script:
    - apt update && apt install curl -y
    - PYTHON_VERSION=`cat .python-version`
    - curl -LsSf https://astral.sh/uv/install.sh | sh
    - source $HOME/.local/bin/env
    - uv venv --python $PYTHON_VERSION .saferlearn
    - source ./.saferlearn/bin/activate

requirements:
  needs: []
  parallel:
    matrix:
      - PYTHON_VERSION: ["3.10"]
  stage: build
  script:
    - apt update && apt install curl -y
    - PYTHON_VERSION=`cat .python-version`
    - curl -LsSf https://astral.sh/uv/install.sh | sh
    - source $HOME/.local/bin/env
    - uv venv --python $PYTHON_VERSION .saferlearn
    - source ./.saferlearn/bin/activate
    - python --version # For debugging
    - uv pip sync requirements.txt
  tags:
    - gpu

sast:
  before_script: []
  stage: test
  # rules:
  #   - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  #   - if: $CI_COMMIT_BRANCH == "dev"

secret_detection:
  before_script: []
  stage: test
  # rules:
  #   - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  #   - if: $CI_COMMIT_BRANCH == "dev"

gemnasium-python-dependency_scanning:
  # Work around https://gitlab.com/gitlab-org/gitlab/-/issues/7006
  before_script: []
  stage: test
  # rules:
  #   - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  #   - if: $CI_COMMIT_BRANCH == "dev"

include:
  - template: Security/SAST.gitlab-ci.yml
  - template: Security/Secret-Detection.gitlab-ci.yml
  - template: Security/Dependency-Scanning.gitlab-ci.yml

test:
  needs: ["requirements"]
  dependencies: ["requirements"]
  script:
    - pip install tox flake8
    # check source codes, ignore long lines error (E501), put --exit-zero to avoid stopping on error
    - flake8 --ignore E501 src/ # --exit-zero
    #- python setup.py test
    #- tox -e py36,flake8

pipy-nightly:
  needs: ["requirements"]
  dependencies: ["requirements"]
  parallel:
    matrix:
      - PYTHON_VERSION: ["3.10"]
  stage: deploy
  script:
    - uv build
    - export UV_PUBLISH_URL=https://gitlab.thalesdigital.io/api/v4/projects/${CI_PROJECT_ID}/packages/pypi
    - uv publish
  artifacts:
    when: always
    expire_in: never
    paths:
      - dist
  except:
    - main
# run:
#  script:
#    - python setup.py bdist_wheel
#    # an alternative approach is to install and run:
#    - pip install dist/*
#    # run the command here
#  artifacts:
#    paths:
#      - dist/*.whl

#pages:
#  script:
#    - pip install sphinx sphinx-rtd-theme
#    - cd doc
#    - make html
#    - mv build/html/ ../public/
#  artifacts:
#    paths:
#      - public
#  rules:
#    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

#deploy:
#  stage: deploy
#  script: echo "Define your deployment script!"
#  environment: production
